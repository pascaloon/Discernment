<DataTemplate xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
              xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <DataTemplate.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </DataTemplate.Resources>
    <Grid Background="#FF252526">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Border Grid.Row="0" Background="#FF2D2D30" 
                Padding="12" 
                Margin="0,0,0,1"
                BorderBrush="#FF3F3F46" 
                BorderThickness="0,0,0,1">
            <StackPanel>
                <TextBlock Text="Variable Insight - Interactive Graph" 
                          FontSize="16" 
                          FontWeight="Bold" 
                          Foreground="#FFFFFFFF"
                          Margin="0,0,0,10"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" Grid.Column="0" 
                              Text="Variable: " 
                              Foreground="#FFB0B0B0" 
                              Margin="0,0,8,5"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" 
                              Text="{Binding RootVariableName}" 
                              Foreground="#FFFFFFFF" 
                              FontWeight="Bold" 
                              Margin="0,0,0,5"/>
                    
                    <TextBlock Grid.Row="1" Grid.Column="0" 
                              Text="Type: " 
                              Foreground="#FFB0B0B0" 
                              Margin="0,0,8,5"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" 
                              Text="{Binding RootVariableType}" 
                              Foreground="#FF4EC9B0" 
                              Margin="0,0,0,5"/>
                    
                    <TextBlock Grid.Row="2" Grid.Column="0" 
                              Text="Location: " 
                              Foreground="#FFB0B0B0" 
                              Margin="0,0,8,0"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" 
                              Text="{Binding RootVariableLocation}" 
                              Foreground="#FFDCDCDC"/>
                </Grid>
            </StackPanel>
        </Border>

        <!-- Summary Section -->
        <Border Grid.Row="1" 
                Background="#FF3E3E42" 
                Padding="12" 
                Margin="0,0,0,1" 
                BorderBrush="#FF3F3F46" 
                BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Total Affecting Elements: " 
                          Foreground="#FFB0B0B0" 
                          Margin="0,0,8,0"/>
                <TextBlock Text="{Binding TotalReferences}" 
                          Foreground="#FF569CD6" 
                          FontWeight="Bold"/>
                <TextBlock Text=" | Use mouse wheel to zoom, drag to pan" 
                          Foreground="#FF888888" 
                          FontStyle="Italic"
                          Margin="20,0,0,0"/>
            </StackPanel>
        </Border>

        <!-- Interactive Graph Canvas -->
        <ScrollViewer Grid.Row="2" 
                     HorizontalScrollBarVisibility="Auto" 
                     VerticalScrollBarVisibility="Auto"
                     Background="#FF1E1E1E">
            <Canvas Width="3000" Height="2500">
                <!-- Edges (draw first so they appear behind nodes) -->
                <ItemsControl ItemsSource="{Binding Edges}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Canvas>
                                <!-- Use Path with combined geometry for line and arrowhead -->
                                <Path Stroke="{Binding EdgeColor}" 
                                      StrokeThickness="3"
                                      Fill="{Binding EdgeColor}"
                                      Opacity="{Binding EdgeOpacity}"
                                      Data="{Binding PathData}"/>
                                
                                <!-- Edge label (only shown for certain edge types like "Override") -->
                                <Border Canvas.Left="{Binding LabelX}" 
                                        Canvas.Top="{Binding LabelY}"
                                        Background="#FF2D2D30"
                                        BorderBrush="{Binding EdgeColor}"
                                        BorderThickness="1"
                                        CornerRadius="3"
                                        Padding="6,2"
                                        Visibility="{Binding ShowLabel, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <TextBlock Text="{Binding RelationKind}" 
                                              Foreground="#FFFFFFFF"
                                              FontSize="11"
                                              FontWeight="Bold"/>
                                </Border>
                            </Canvas>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Nodes -->
                <ItemsControl ItemsSource="{Binding Nodes}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style>
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Background="Transparent"
                                    BorderThickness="0"
                                    Padding="0"
                                    Cursor="Hand"
                                    Command="{Binding DataContext.SelectNodeCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                    CommandParameter="{Binding}">
                                <Border x:Name="NodeBorder"
                                        Background="#FF2D2D30" 
                                        BorderBrush="#FF3F3F46" 
                                        BorderThickness="2"
                                        CornerRadius="5"
                                        Padding="10"
                                        Width="300">
                                    <StackPanel>
                                    <!-- Node Name with color-coded background -->
                                    <Border Background="{Binding HeaderBackgroundColor}"
                                            Padding="8,4"
                                            Margin="-10,-10,-10,5"
                                            CornerRadius="3,3,0,0">
                                        <TextBlock Text="{Binding Name}" 
                                                  FontWeight="Bold" 
                                                  FontSize="14"
                                                  Foreground="#FFFFFFFF"/>
                                    </Border>
                                    
                                    <!-- Type -->
                                    <TextBlock FontSize="11"
                                              Foreground="#FF4EC9B0"
                                              Margin="0,0,0,5">
                                        <Run Text="Type: "/>
                                        <Run Text="{Binding Type}" FontWeight="Bold"/>
                                    </TextBlock>
                                    
                                    <!-- Source Code Line with Goto Button -->
                                    <Border x:Name="SourceCodeBorder"
                                            Background="#FF1E1E1E" 
                                            BorderBrush="#FF3F3F46"
                                            BorderThickness="1"
                                            Padding="8,5"
                                            Margin="0,5,0,5">
                                        <Grid>
                                            <TextBlock Text="{Binding SourceCode}" 
                                                      FontFamily="Consolas"
                                                      FontSize="11"
                                                      Foreground="#FFD4D4D4"
                                                      TextWrapping="Wrap"
                                                      Margin="0,0,35,0"/>
                                            
                                            <!-- Goto Button (appears on hover) -->
                                            <Button x:Name="GotoButton"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top"
                                                    Width="28"
                                                    Height="28"
                                                    Background="#FF555555"
                                                    BorderThickness="0"
                                                    Cursor="Hand"
                                                    Opacity="0"
                                                    Command="{Binding DataContext.NavigateToSourceCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Go to source location">
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border x:Name="ButtonBorder"
                                                                Background="{TemplateBinding Background}"
                                                                CornerRadius="3"
                                                                BorderThickness="0">
                                                            <!-- Arrow Icon (→) -->
                                                            <TextBlock x:Name="ArrowIcon"
                                                                      Text="→" 
                                                                      FontSize="18"
                                                                      FontWeight="Bold"
                                                                      Foreground="White"
                                                                      HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"
                                                                      Margin="0,-2,0,0">
                                                                <TextBlock.RenderTransform>
                                                                    <ScaleTransform ScaleX="1" ScaleY="1" CenterX="9" CenterY="9"/>
                                                                </TextBlock.RenderTransform>
                                                            </TextBlock>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Trigger.EnterActions>
                                                                    <BeginStoryboard>
                                                                        <Storyboard>
                                                                            <ColorAnimation Storyboard.TargetName="ButtonBorder"
                                                                                          Storyboard.TargetProperty="Background.Color"
                                                                                          To="#FF007ACC"
                                                                                          Duration="0:0:0.15"/>
                                                                            <DoubleAnimation Storyboard.TargetName="ArrowIcon"
                                                                                           Storyboard.TargetProperty="RenderTransform.ScaleX"
                                                                                           To="1.15"
                                                                                           Duration="0:0:0.15"/>
                                                                            <DoubleAnimation Storyboard.TargetName="ArrowIcon"
                                                                                           Storyboard.TargetProperty="RenderTransform.ScaleY"
                                                                                           To="1.15"
                                                                                           Duration="0:0:0.15"/>
                                                                        </Storyboard>
                                                                    </BeginStoryboard>
                                                                </Trigger.EnterActions>
                                                                <Trigger.ExitActions>
                                                                    <BeginStoryboard>
                                                                        <Storyboard>
                                                                            <ColorAnimation Storyboard.TargetName="ButtonBorder"
                                                                                          Storyboard.TargetProperty="Background.Color"
                                                                                          To="#FF555555"
                                                                                          Duration="0:0:0.15"/>
                                                                            <DoubleAnimation Storyboard.TargetName="ArrowIcon"
                                                                                           Storyboard.TargetProperty="RenderTransform.ScaleX"
                                                                                           To="1"
                                                                                           Duration="0:0:0.15"/>
                                                                            <DoubleAnimation Storyboard.TargetName="ArrowIcon"
                                                                                           Storyboard.TargetProperty="RenderTransform.ScaleY"
                                                                                           To="1"
                                                                                           Duration="0:0:0.15"/>
                                                                        </Storyboard>
                                                                    </BeginStoryboard>
                                                                </Trigger.ExitActions>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Button.Template>
                                            </Button>
                                        </Grid>
                                    </Border>
                                    
                                        <!-- Location -->
                                        <TextBlock Text="{Binding Location}" 
                                                  FontSize="10"
                                                  Foreground="#FF888888"
                                                  FontStyle="Italic"/>
                                    </StackPanel>
                                </Border>
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <ContentPresenter/>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                    <Setter TargetName="NodeBorder" Property="BorderBrush" Value="#FF007ACC"/>
                                    <Setter TargetName="NodeBorder" Property="BorderThickness" Value="3"/>
                                </DataTrigger>
                                <Trigger SourceName="SourceCodeBorder" Property="IsMouseOver" Value="True">
                                    <Setter TargetName="GotoButton" Property="Opacity" Value="1"/>
                                </Trigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Canvas>
        </ScrollViewer>
    </Grid>
</DataTemplate>
